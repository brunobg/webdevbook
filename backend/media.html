<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Media | A full stack approach to integrated web and native app development</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="Creating native and web apps using Vue, NativeScript and Laravel">
    <link rel="preload" href="/webdevbook/assets/css/0.styles.6f5b36b1.css" as="style"><link rel="preload" href="/webdevbook/assets/js/app.1cf335a2.js" as="script"><link rel="preload" href="/webdevbook/assets/js/2.d065ae5f.js" as="script"><link rel="preload" href="/webdevbook/assets/js/16.f3301507.js" as="script"><link rel="prefetch" href="/webdevbook/assets/js/10.c87da69f.js"><link rel="prefetch" href="/webdevbook/assets/js/11.ca758054.js"><link rel="prefetch" href="/webdevbook/assets/js/12.a93f3d54.js"><link rel="prefetch" href="/webdevbook/assets/js/13.1aeeb621.js"><link rel="prefetch" href="/webdevbook/assets/js/14.95d7855b.js"><link rel="prefetch" href="/webdevbook/assets/js/15.bfac4853.js"><link rel="prefetch" href="/webdevbook/assets/js/17.0c0c23e5.js"><link rel="prefetch" href="/webdevbook/assets/js/18.4d6af17a.js"><link rel="prefetch" href="/webdevbook/assets/js/19.be8c9587.js"><link rel="prefetch" href="/webdevbook/assets/js/20.8f6dd8bd.js"><link rel="prefetch" href="/webdevbook/assets/js/21.9a0bdbdc.js"><link rel="prefetch" href="/webdevbook/assets/js/22.81b13454.js"><link rel="prefetch" href="/webdevbook/assets/js/23.a40c4fbc.js"><link rel="prefetch" href="/webdevbook/assets/js/24.851b54e9.js"><link rel="prefetch" href="/webdevbook/assets/js/25.67c32603.js"><link rel="prefetch" href="/webdevbook/assets/js/26.66229317.js"><link rel="prefetch" href="/webdevbook/assets/js/27.b0467bfe.js"><link rel="prefetch" href="/webdevbook/assets/js/28.29acf9e8.js"><link rel="prefetch" href="/webdevbook/assets/js/29.95a6bd47.js"><link rel="prefetch" href="/webdevbook/assets/js/3.d727a3b8.js"><link rel="prefetch" href="/webdevbook/assets/js/30.3608412d.js"><link rel="prefetch" href="/webdevbook/assets/js/31.e2ced364.js"><link rel="prefetch" href="/webdevbook/assets/js/32.1437a2da.js"><link rel="prefetch" href="/webdevbook/assets/js/33.b94cbcaa.js"><link rel="prefetch" href="/webdevbook/assets/js/34.4bf33957.js"><link rel="prefetch" href="/webdevbook/assets/js/35.e4fcb519.js"><link rel="prefetch" href="/webdevbook/assets/js/36.26ab1602.js"><link rel="prefetch" href="/webdevbook/assets/js/37.3d237bbe.js"><link rel="prefetch" href="/webdevbook/assets/js/38.42a47cdc.js"><link rel="prefetch" href="/webdevbook/assets/js/39.60a8024c.js"><link rel="prefetch" href="/webdevbook/assets/js/4.a5e83b20.js"><link rel="prefetch" href="/webdevbook/assets/js/40.2a034950.js"><link rel="prefetch" href="/webdevbook/assets/js/41.cfef1a3a.js"><link rel="prefetch" href="/webdevbook/assets/js/42.ec88c83c.js"><link rel="prefetch" href="/webdevbook/assets/js/5.cda929b9.js"><link rel="prefetch" href="/webdevbook/assets/js/6.423fdf70.js"><link rel="prefetch" href="/webdevbook/assets/js/7.8ebb662b.js"><link rel="prefetch" href="/webdevbook/assets/js/8.1f0319bc.js"><link rel="prefetch" href="/webdevbook/assets/js/9.f8fb6885.js">
    <link rel="stylesheet" href="/webdevbook/assets/css/0.styles.6f5b36b1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/webdevbook/" class="home-link router-link-active"><!----> <span class="site-name">A full stack approach to integrated web and native app development</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/webdevbook/" aria-current="page" class="sidebar-link">Home</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Frontend</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Backend</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/webdevbook/backend/introduction.html" class="sidebar-link">Introduction</a></li><li><a href="/webdevbook/backend/architecture.html" class="sidebar-link">Architecture</a></li><li><a href="/webdevbook/backend/structure.html" class="sidebar-link">Code structure</a></li><li><a href="/webdevbook/backend/setup.html" class="sidebar-link">Setup the project</a></li><li><a href="/webdevbook/backend/testing.html" class="sidebar-link">Testing</a></li><li><a href="/webdevbook/backend/models.html" class="sidebar-link">Models</a></li><li><a href="/webdevbook/backend/database.html" class="sidebar-link">Database</a></li><li><a href="/webdevbook/backend/routing.html" class="sidebar-link">Routing</a></li><li><a href="/webdevbook/backend/controllers.html" class="sidebar-link">Controllers</a></li><li><a href="/webdevbook/backend/authentication.html" class="sidebar-link">Authentication</a></li><li><a href="/webdevbook/backend/security.html" class="sidebar-link">Security</a></li><li><a href="/webdevbook/backend/deployment.html" class="sidebar-link">Deployment</a></li><li><a href="/webdevbook/backend/ssr.html" class="sidebar-link">Server side rendering</a></li><li><a href="/webdevbook/backend/media.html" aria-current="page" class="active sidebar-link">Media</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/webdevbook/backend/media.html#file-upload" class="sidebar-link">File upload</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/webdevbook/backend/media.html#with-laravel" class="sidebar-link">With Laravel</a></li><li class="sidebar-sub-header"><a href="/webdevbook/backend/media.html#with-laravel-medialibrary" class="sidebar-link">With Laravel-medialibrary</a></li><li class="sidebar-sub-header"><a href="/webdevbook/backend/media.html#in-graphql-with-lighthouse" class="sidebar-link">In GraphQL with Lighthouse:</a></li></ul></li><li class="sidebar-sub-header"><a href="/webdevbook/backend/media.html#storage" class="sidebar-link">Storage</a></li><li class="sidebar-sub-header"><a href="/webdevbook/backend/media.html#restricting-access" class="sidebar-link">Restricting access</a></li></ul></li><li><a href="/webdevbook/backend/pushcommunication.html" class="sidebar-link">Push communication</a></li><li><a href="/webdevbook/backend/scraping.html" class="sidebar-link">Scraping and crawlers</a></li><li><a href="/webdevbook/backend/last.html" class="sidebar-link">Where to go from here</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="media"><a href="#media" class="header-anchor">#</a> Media</h1> <p>Most applications need to handle media dynamically. Whether it's contents (product pictures), user avatars, picture posts, videos, it's a common feature. It requires files to be uploaded, processed (to validate the file integrity, resolution, possibly analyze contents, generate thumbnails) and be stored in a publicly accessible, but possibly restricted by user, location.</p> <p>Laravel has a <a href="https://laravel.com/docs/8.x/filesystem" target="_blank" rel="noopener noreferrer">filesystem abstraction<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. It includes functions to handle uploads and storage. But media upload and storage can become hard quickly. It's a vector for attacks, including denial of service. It's best to use libraries to handle it, but make sure to add checks to ensure files uploaded match what you expect, in terms of file type, size and contents.</p> <p>A wonderful library to handle files is <a href="https://spatie.be/docs/laravel-medialibrary/v8/introduction" target="_blank" rel="noopener noreferrer">Laravel-medialibrary<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. It is easy to use and handles association with models in a very simple and Laravel-like way.</p> <p><a href="https://lighthouse-php.com/3.1/guides/file-uploads.html" target="_blank" rel="noopener noreferrer">LighthousePHP also supports uploads, directly in GraphQl<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="file-upload"><a href="#file-upload" class="header-anchor">#</a> File upload</h2> <h3 id="with-laravel"><a href="#with-laravel" class="header-anchor">#</a> With Laravel</h3> <p>The file is part of the <code>Request</code> object, and can be stored directly from it:</p> <div class="language-php extra-class"><pre class="language-php"><code>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$path</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'avatar'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'avatars'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$path</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>You can also store it in a S3-like service, as we'll see below.</p> <h3 id="with-laravel-medialibrary"><a href="#with-laravel-medialibrary" class="header-anchor">#</a> With Laravel-medialibrary</h3> <p>You can associate the file directly to a model:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$yourModel</span> <span class="token operator">=</span> YourModel<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$yourModel</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addMediaFromRequest</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'image'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">toMediaCollection</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'images'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>It includes support for S3-like services as well, using Laravel's filesystem for that. It also includes several processing modules, such as converting images to several resolutions, optimizing images etc.</p> <h3 id="in-graphql-with-lighthouse"><a href="#in-graphql-with-lighthouse" class="header-anchor">#</a> In GraphQL with Lighthouse:</h3> <p>This is handed with a special scalar type, which you should declare in your schema:</p> <div class="language-graphql extra-class"><pre class="language-graphql"><code><span class="token description string">&quot;<span class="token language-markdown">Can be used as an argument to upload files using https://github.com/jaydenseric/graphql-multipart-request-spec</span>&quot;</span>
<span class="token keyword">scalar</span> <span class="token class-name">Upload</span>
  <span class="token directive function">@scalar</span><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">:</span> <span class="token string">&quot;Nuwave\\Lighthouse\\Schema\\Types\\Scalars\\Upload&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Once the scalar is added, you can add it to a mutation.</p> <div class="language-graphql extra-class"><pre class="language-graphql"><code><span class="token keyword">type</span> <span class="token class-name">Mutation</span> <span class="token punctuation">{</span>
  <span class="token description string">&quot;<span class="token language-markdown">Upload a file that is publicly available.</span>&quot;</span>
  <span class="token attr-name">upload</span><span class="token punctuation">(</span><span class="token attr-name">file</span><span class="token punctuation">:</span> Upload<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span> String
<span class="token punctuation">}</span>
</code></pre></div><p>You process the file on your mutation callback. There you can do whatever you want with your file, including using Laravel-medialibrary.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>GraphQL<span class="token punctuation">\</span>Mutations</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Upload</span>
<span class="token punctuation">{</span>
    <span class="token comment">/**
     * Upload a file, store it on the server and return the path.
     *
     * @param  mixed  $root
     * @param  array&lt;string, mixed&gt;  $args
     * @return string|null
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token variable">$root</span><span class="token punctuation">,</span> <span class="token keyword">array</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span>string
    <span class="token punctuation">{</span>
        <span class="token comment">/** @var \Illuminate\Http\UploadedFile $file */</span>
        <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$args</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// process the file/save it</span>
        <span class="token keyword">return</span> <span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">storePublicly</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'uploads'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="storage"><a href="#storage" class="header-anchor">#</a> Storage</h2> <p>The most traditional way to store files is on the server disk. Object storage, with services such as AWS S3 or similar ones are also possible. They are carefree -- you don't worry about disk limits, storage, backups, availability, scalability; as long as you pay the bill, it's fine. Most of them follow the same API.</p> <p>Laravel offers a <a href="https://laravel.com/docs/8.x/filesystem" target="_blank" rel="noopener noreferrer">file storage system<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that can use different adapters. The local driver, which is the default, uses a local disk for storage. But you can use the S3 driver for object storage. Laravel abstracts the access with a simple API.</p> <h2 id="restricting-access"><a href="#restricting-access" class="header-anchor">#</a> Restricting access</h2> <p>Remember than any files in the <code>public</code> directory are accessible by anyone with its URL. If you need to restrict access there by user there are a few solutions.</p> <p>One is to store data in a folder that is not accessible publicly, and create an endpoint to serve the files, such as <code>/files/$id</code>. Then you can implement a controller for that route, which checks policy through middleware. The controller endpoint will be more or less like this:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">file</span><span class="token punctuation">(</span><span class="token variable">$file_url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Response<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">make</span><span class="token punctuation">(</span>Storage<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">disk</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'mydisk'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$file_url</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If you are using external block storage the same idea works, but instead of serving the file, just redirect it to a temporary URL</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">fule</span><span class="token punctuation">(</span><span class="token variable">$file_url</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$url</span> <span class="token operator">=</span> Storage<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">disk</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'s3'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">temporaryUrl</span><span class="token punctuation">(</span><span class="token variable">$file_url</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/webdevbook/backend/ssr.html" class="prev">
        Server side rendering
      </a></span> <span class="next"><a href="/webdevbook/backend/pushcommunication.html">
        Push communication
      </a>
      →
    </span></p></div> </main> <footer data-v-136409f7><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" data-v-136409f7><img alt="Creative Commons License" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" style="border-width: 0;" data-v-136409f7></a> <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type" data-v-136409f7>A full stack approach to integrated web and native app development</span>
  by
  <span xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName" data-v-136409f7>Bruno Barberi Gnecco</span>
  is licensed under a
  <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" data-v-136409f7>Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International
    License</a>.
</footer></div><div class="global-ui"></div></div>
    <script src="/webdevbook/assets/js/app.1cf335a2.js" defer></script><script src="/webdevbook/assets/js/2.d065ae5f.js" defer></script><script src="/webdevbook/assets/js/16.f3301507.js" defer></script>
  </body>
</html>
